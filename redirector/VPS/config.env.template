# ==============================================================================
# L4 Redirector v4.0 - Production Configuration Template
# ==============================================================================
#
# INSTRUCTIONS:
#   1. Copy this file to /etc/l4-redirector/config.env
#   2. Generate secure tokens (see below)
#   3. Update all values with your production settings
#   4. Secure the file with proper permissions
#   5. Validate configuration before deployment
#
# SECURITY WARNING:
#   - NEVER commit this file with real credentials to version control
#   - ALWAYS use strong, randomly generated tokens
#   - ALWAYS set restrictive file permissions (600)
#   - ROTATE tokens regularly (recommended: every 90 days)
#
# ==============================================================================

# ==============================================================================
# AUTHENTICATION TOKENS
# ==============================================================================
#
# Both tokens MUST be exactly 64 hexadecimal characters (32 bytes)
# Generate using: openssl rand -hex 32
#
# BACKEND_API_TOKEN:
#   - Used for authenticating requests to the Windows backend API
#   - Must match the token configured on the backend server
#   - Transmitted in Authorization header: "Bearer <token>"
#
# API_AUTH_TOKEN:
#   - Used for authenticating monitoring API requests
#   - Required for accessing /status endpoint
#   - Should be different from BACKEND_API_TOKEN
#
# SECURITY REQUIREMENTS:
#   - Minimum 64 characters (hexadecimal)
#   - Generated from cryptographically secure random source
#   - Never reuse tokens across environments
#   - Store tokens securely (e.g., password manager, secrets vault)
#
# GENERATE TOKENS:
#   openssl rand -hex 32
#   python3 -c "import secrets; print(secrets.token_hex(32))"
#

# Backend API authentication token (64 hex chars)
# REQUIRED: Replace with your generated token
BACKEND_API_TOKEN=REPLACE_WITH_YOUR_64_CHAR_HEX_TOKEN_HERE_0000000000000000

# Monitoring API authentication token (64 hex chars)
# REQUIRED: Replace with your generated token (must be different from above)
API_AUTH_TOKEN=REPLACE_WITH_YOUR_64_CHAR_HEX_TOKEN_HERE_1111111111111111

# ==============================================================================
# LOCALTONET / WIREGUARD GATEWAY CONFIGURATION
# ==============================================================================
#
# These settings define the backend API endpoint for pushing connection metadata.
# This is typically your Windows machine accessible via LocalToNet or WireGuard.
#
# LOCALTONET_IP:
#   - IP address of your LocalToNet tunnel or WireGuard endpoint
#   - Must be reachable from this VPS
#   - Can be public IP or private IP if using VPN
#
# LOCALTONET_PORT:
#   - Port where your backend API is listening
#   - Default backend API port is usually 6921
#   - Must be an integer between 1 and 65535
#
# API ENDPOINT:
#   The service will connect to: http://{LOCALTONET_IP}:{LOCALTONET_PORT}/connections
#
# VALIDATION:
#   Test connectivity before deployment:
#   curl -H "Authorization: Bearer $BACKEND_API_TOKEN" \
#        http://{LOCALTONET_IP}:{LOCALTONET_PORT}/connections
#

# Gateway IP address
# REQUIRED: Replace with your actual gateway IP
# Examples:
#   Public IP: 203.0.113.45
#   LocalToNet: 194.182.64.133
#   WireGuard VPN: 10.8.0.1
LOCALTONET_IP=REPLACE_WITH_YOUR_GATEWAY_IP

# Gateway port number
# REQUIRED: Replace with your actual gateway port
# Common values: 6921 (LocalToNet default), 8080, 443
LOCALTONET_PORT=6921

# ==============================================================================
# PORT MAPPING CONFIGURATION
# ==============================================================================
#
# Defines which ports the redirector listens on and where to forward traffic.
#
# FORMAT:
#   JSON object with string keys (frontend ports) and array values [host, port]
#   PORT_MAP='{"frontend_port": ["backend_host", backend_port], ...}'
#
# PARAMETERS:
#   - frontend_port: Port to listen on (string, will be converted to int)
#   - backend_host: Target backend hostname or IP address (string)
#   - backend_port: Target backend port (integer)
#
# REQUIREMENTS:
#   - Must be valid JSON (use single quotes around the entire string)
#   - All ports must be between 1 and 65535
#   - Backend hosts must be reachable from VPS
#   - At least one port mapping is required
#
# PORT SELECTION:
#   - Ports < 1024 require root privileges (consider ports >= 1024)
#   - Avoid ports used by other services (22, 80, 443, etc.)
#   - Check availability: sudo netstat -tlnp | grep <port>
#
# EXAMPLES:
#
# Single port mapping:
#   PORT_MAP='{"8041": ["192.168.1.100", 1429]}'
#
# Multiple ports to same backend:
#   PORT_MAP='{"8041": ["192.168.1.100", 1429], "8047": ["192.168.1.100", 8667]}'
#
# Multiple ports to different backends:
#   PORT_MAP='{"8041": ["192.168.1.100", 1429], "8047": ["192.168.1.200", 8667]}'
#
# Using hostnames (ensure DNS resolution works):
#   PORT_MAP='{"8041": ["backend.example.com", 1429], "8047": ["backend.example.com", 8667]}'
#
# Production example with 3 services:
#   PORT_MAP='{"8041": ["10.0.1.100", 1429], "8047": ["10.0.1.100", 8667], "8057": ["10.0.1.200", 7798]}'
#

# Port mapping configuration
# REQUIRED: Replace with your actual port mappings
# Start with a simple single-port example and expand as needed
PORT_MAP='{"8041": ["REPLACE_WITH_BACKEND_IP", 1429]}'

# ==============================================================================
# DEPLOYMENT VALIDATION CHECKLIST
# ==============================================================================
#
# Before starting the service, verify:
#
# [ ] 1. All REPLACE_WITH_* placeholders have been updated
# [ ] 2. Tokens are exactly 64 hexadecimal characters
# [ ] 3. Tokens are different from each other
# [ ] 4. Gateway IP is reachable: ping $LOCALTONET_IP
# [ ] 5. Gateway port is accessible: nc -zv $LOCALTONET_IP $LOCALTONET_PORT
# [ ] 6. Backend hosts are reachable from VPS
# [ ] 7. PORT_MAP is valid JSON: echo $PORT_MAP | python3 -m json.tool
# [ ] 8. All ports are not already in use: sudo netstat -tlnp
# [ ] 9. File permissions are secure: sudo chmod 600 /etc/l4-redirector/config.env
# [ ] 10. File ownership is correct: sudo chown root:root /etc/l4-redirector/config.env
#
# ==============================================================================
# SECURE FILE AFTER CONFIGURATION
# ==============================================================================
#
# Execute these commands after editing:
#
#   sudo chmod 600 /etc/l4-redirector/config.env
#   sudo chown root:root /etc/l4-redirector/config.env
#
# Verify permissions:
#   ls -la /etc/l4-redirector/config.env
#   # Should show: -rw------- 1 root root
#
# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================
#
# Configuration validation:
#   python3 -c "import os, json; print(json.loads(os.getenv('PORT_MAP', '{}')))"
#
# Test backend API connectivity:
#   curl -v -H "Authorization: Bearer $BACKEND_API_TOKEN" \
#        -H "Content-Type: application/json" \
#        -d '{"test": "connection"}' \
#        http://$LOCALTONET_IP:$LOCALTONET_PORT/connections
#
# Check environment loading:
#   sudo systemctl show l4-redirector-v4 --property=Environment
#
# View service logs:
#   sudo journalctl -u l4-redirector-v4 -f
#
# ==============================================================================
# ENVIRONMENT SPECIFIC EXAMPLES
# ==============================================================================
#
# DEVELOPMENT:
#   LOCALTONET_IP=localhost
#   LOCALTONET_PORT=6921
#   PORT_MAP='{"8041": ["localhost", 1429]}'
#
# STAGING:
#   LOCALTONET_IP=staging.internal.example.com
#   LOCALTONET_PORT=6921
#   PORT_MAP='{"8041": ["staging-backend.internal", 1429]}'
#
# PRODUCTION:
#   LOCALTONET_IP=194.182.64.133
#   LOCALTONET_PORT=6921
#   PORT_MAP='{"8041": ["10.0.1.100", 1429], "8047": ["10.0.1.100", 8667], "8057": ["10.0.1.200", 7798]}'
#
# ==============================================================================
# MAINTENANCE NOTES
# ==============================================================================
#
# Token Rotation Schedule:
#   - Review tokens quarterly (every 90 days)
#   - Rotate immediately if compromise is suspected
#   - Update both VPS and backend server simultaneously
#   - Test connectivity after rotation
#
# Configuration Updates:
#   1. Edit this file with new values
#   2. Validate changes (see checklist above)
#   3. Reload service: sudo systemctl reload l4-redirector-v4
#   4. Verify service status: sudo systemctl status l4-redirector-v4
#   5. Check logs for errors: sudo journalctl -u l4-redirector-v4 -n 50
#
# Backup:
#   - Keep encrypted backups of this file
#   - Store in secure location (password manager, secrets vault)
#   - Never store in version control or shared drives
#
# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
