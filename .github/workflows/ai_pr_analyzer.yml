name: AI PR Analyzer

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

# Grant permissions for the action to write comments on pull requests
permissions:
  pull-requests: write

jobs:
  analyze_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp openai anthropic google-generativeai groq cohere mistralai
          pip install multidict yarl attrs aiosignal frozenlist python-dotenv

      - name: ðŸ¤– Run BULLETPROOF PR Analysis
        run: |
          echo "ðŸš€ Running BULLETPROOF PR analysis..."
          
          # Run BULLETPROOF real AI analysis
          python .github/scripts/comprehensive_pr_analyzer_bulletproof.py
          
          # CRITICAL: Validate bulletproof real AI was used
          if grep -q '"bulletproof_validated": true' artifacts/auto_pr_analysis.json; then
            echo "âœ… BULLETPROOF REAL AI VERIFIED!"
            # Copy for compatibility
            cp artifacts/auto_pr_analysis.json comprehensive_pr_analysis.json
          else
            echo "ðŸš¨ FAKE AI DETECTED - FAILING HARD!"
            exit 1
          fi
        env:
          # GitHub token for API access
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # All 16 AI Provider API Keys
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
          CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
          GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
          GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: ai-pr-analysis-results
          path: |
            comprehensive_pr_analysis.json
            final_results/comprehensive_pr_analysis.json