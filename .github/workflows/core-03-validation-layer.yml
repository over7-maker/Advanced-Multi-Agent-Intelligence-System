name: Core-3: Validation Layer

# Consolidated Validation Layer Workflow
# Combines: Workflow Validation, PR CI Checks, Web CI, Architecture Validation
# Part of Workflow Consolidation: 46 workflows â†’ 8 cores

on:
  # Event triggers
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'tests/**'
      - 'web/**'
      - 'docs/images/**'
  push:
    branches: [main, develop]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'tests/**'
      - 'web/**'
      - 'docs/images/**'
  # Manual dispatch
  workflow_dispatch:
    inputs:
      validation_mode:
        description: 'Validation Mode'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - workflow-only
          - code-quality-only
          - security-only
          - web-only
          - architecture-only
      strict_mode:
        description: 'Strict Mode (fail on warnings)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  VALIDATION_MODE: ${{ github.event.inputs.validation_mode || 'comprehensive' }}
  STRICT_MODE: ${{ github.event.inputs.strict_mode || 'false' }}

jobs:
  # Job 1: Workflow Validation
  workflow_validation:
    name: ğŸ” Workflow Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: env.VALIDATION_MODE == 'comprehensive' || env.VALIDATION_MODE == 'workflow-only'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ” Install and Run Actionlint
      continue-on-error: true
      run: |
        echo "ğŸ” Attempting to install actionlint..."
        
        # Try official install script
        curl -sSfL https://raw.githubusercontent.com/rhymond/actionlint/main/scripts/install-actionlint.bash 2>/dev/null | bash -s 2>/dev/null || true
        
        # Try direct binary download
        if ! command -v actionlint >/dev/null 2>&1; then
          echo "Trying direct download..."
          curl -sSfL https://github.com/rhymond/actionlint/releases/download/v1.7.7/actionlint_1.7.7_linux_amd64.tar.gz -o /tmp/actionlint.tar.gz 2>/dev/null || true
          if [ -f /tmp/actionlint.tar.gz ]; then
            tar -xzf /tmp/actionlint.tar.gz -C /tmp actionlint 2>/dev/null || true
            if [ -f /tmp/actionlint ]; then
              sudo mv /tmp/actionlint /usr/local/bin/ 2>/dev/null || true
              chmod +x /usr/local/bin/actionlint 2>/dev/null || true
            fi
          fi
        fi
        
        # Run actionlint if available
        if command -v actionlint >/dev/null 2>&1; then
          echo "âœ… Actionlint installed successfully"
          actionlint --version
          echo "Running actionlint validation..."
          actionlint -color $(find .github/workflows -name '*.yml' -o -name '*.yaml' 2>/dev/null) || {
            echo "::warning::Actionlint found issues (non-blocking)"
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
        else
          echo "::warning::Actionlint not available - skipping validation"
        fi
    
    - name: âœ… Validate YAML Syntax
      continue-on-error: true
      run: |
        echo "âœ… Validating YAML syntax for workflow files..."
        errors=0
        for file in $(find .github/workflows -name '*.yml' -o -name '*.yaml' | sort); do
          echo "Validating $file"
          if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo "::error file=$file::YAML syntax error detected"
            errors=$((errors + 1))
          else
            echo "âœ… $file is valid"
          fi
        done
        if [ $errors -gt 0 ]; then
          echo "::warning::Found $errors YAML file(s) with syntax errors"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        else
          echo "âœ… All YAML files are syntactically valid"
        fi
    
    - name: ğŸ” Check for Common Issues
      continue-on-error: true
      run: |
        echo "ğŸ” Checking for common workflow issues..."
        if [ -f ".github/scripts/validate_workflow_policies.py" ]; then
          python .github/scripts/validate_workflow_policies.py || {
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
        else
          echo "â„¹ï¸ Workflow policy validation script not found, skipping..."
        fi
    
    - name: ğŸ“¤ Upload Validation Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: workflow-validation-results
        path: |
          workflow_validation_*.json
          workflow_validation_*.log
        if-no-files-found: ignore
        retention-days: 30

  # Job 2: Code Quality Validation
  code_quality_validation:
    name: ğŸ¨ Code Quality & Standards
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: env.VALIDATION_MODE == 'comprehensive' || env.VALIDATION_MODE == 'code-quality-only'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ› ï¸ Ensure pip cache directory exists
      run: mkdir -p ~/.cache/pip
    
    - name: ğŸ“¦ Install Dependencies and Quality Tools
      run: |
        pip install -r requirements.txt || echo "No requirements.txt found"
        pip install -r requirements-dev.txt || pip install \
          black==24.3.0 \
          isort==5.13.2 \
          flake8==6.1.0 \
          pylint==3.0.2 \
          mypy==1.7.1 || true
    
    - name: ğŸ¨ Code Formatting Check
      run: |
        echo "ğŸ¨ Checking code formatting..."
        if [ -d "src/" ] || [ -d "tests/" ]; then
          black --check --diff src/ tests/ || {
            echo "âŒ Code formatting issues found. Run 'black src/ tests/' to fix."
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
          
          isort --check-only --diff src/ tests/ || {
            echo "âŒ Import sorting issues found. Run 'isort src/ tests/' to fix."
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
          echo "âœ… Code formatting is correct"
        else
          echo "âš ï¸  No src/ or tests/ directories found, skipping formatting check"
        fi
    
    - name: ğŸ” Linting Validation
      run: |
        echo "ğŸ” Running linting..."
        if [ -d "src/" ]; then
          flake8 src/ tests/ \
            --max-complexity=10 \
            --max-line-length=100 \
            --statistics \
            --count || {
            echo "âŒ Linting issues found"
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
          echo "âœ… Linting passed"
        else
          echo "âš ï¸  No src/ directory found, skipping linting"
        fi
    
    - name: ğŸ“¤ Upload Code Quality Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-results
        path: |
          code_quality_*.json
          code_quality_*.log
        if-no-files-found: ignore
        retention-days: 30

  # Job 3: Security Validation
  security_validation:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: env.VALIDATION_MODE == 'comprehensive' || env.VALIDATION_MODE == 'security-only'
    permissions:
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ› ï¸ Ensure pip cache directory exists
      run: mkdir -p ~/.cache/pip
    
    - name: ğŸ“¦ Install Security Tools
      run: |
        if [ -f requirements-security.txt ]; then
          pip install --user -r requirements-security.txt
        else
          pip install --user \
            safety==3.6.2 \
            pip-audit==2.6.3 \
            bandit==1.7.5 \
            detect-secrets==1.4.0 || true
        fi
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: ğŸ”’ Run Safety Check
      continue-on-error: true
      run: |
        safety check --short-report || {
          echo "âš ï¸  Safety scan found issues"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ›¡ï¸ Run Bandit Scan
      if: exists('src/')
      continue-on-error: true
      run: |
        bandit -r src/ --severity-level medium || {
          echo "âš ï¸  Bandit found issues"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ” Run Detect Secrets
      continue-on-error: true
      run: |
        detect-secrets scan --baseline .secrets.baseline || {
          echo "âš ï¸  Detect-secrets found potential secrets"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ“¤ Upload Security Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-validation-results
        path: |
          security_scan_*.json
          security_scan_*.log
          .secrets.baseline
        if-no-files-found: ignore
        retention-days: 30

  # Job 4: Web CI Validation
  web_validation:
    name: ğŸŒ Web CI Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: env.VALIDATION_MODE == 'comprehensive' || env.VALIDATION_MODE == 'web-only' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'web/'))
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    
    - name: ğŸ“¦ Install Dependencies
      if: exists('web/package.json')
      working-directory: ./web
      run: npm ci || echo "âš ï¸ npm ci failed, trying npm install..." && npm install
    
    - name: ğŸ” Typecheck
      if: exists('web/package.json')
      working-directory: ./web
      continue-on-error: true
      run: |
        npm run typecheck || {
          echo "âŒ Typecheck failed"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ” Lint
      if: exists('web/package.json')
      working-directory: ./web
      continue-on-error: true
      run: |
        npm run lint -- --max-warnings=0 --cache || {
          echo "âŒ Linting failed"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ—ï¸ Build
      if: exists('web/package.json')
      working-directory: ./web
      continue-on-error: true
      run: |
        npm run build || {
          echo "âŒ Build failed"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ§ª Test
      if: exists('web/package.json')
      working-directory: ./web
      continue-on-error: true
      run: |
        npm test -- --watchAll=false --coverage || {
          echo "âŒ Tests failed"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        }
    
    - name: ğŸ“¤ Upload Web Validation Results
      if: always() && exists('web/package.json')
      uses: actions/upload-artifact@v4
      with:
        name: web-validation-results
        path: |
          web/coverage/
          web/build/
        if-no-files-found: ignore
        retention-days: 30

  # Job 5: Architecture Validation
  architecture_validation:
    name: ğŸ—ï¸ Architecture Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: env.VALIDATION_MODE == 'comprehensive' || env.VALIDATION_MODE == 'architecture-only' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'docs/images/'))
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ–¼ï¸ Check Image Exists and is Valid PNG
      run: |
        FILE="docs/images/universal_ai_router_architecture.png"
        if [ ! -f "$FILE" ]; then
          echo "âŒ Missing diagram: $FILE"
          if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
        else
          file "$FILE" | grep -i 'PNG image data' || {
            echo "âŒ Not a valid PNG: $FILE"
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          }
          echo "âœ… Diagram file exists and is valid PNG"
        fi
    
    - name: ğŸ“ Enforce Minimum File Size
      run: |
        FILE="docs/images/universal_ai_router_architecture.png"
        if [ -f "$FILE" ]; then
          BYTES=$(wc -c <"$FILE")
          echo "Diagram size: $BYTES bytes"
          MIN=$((100*1024))
          if [ "$BYTES" -lt "$MIN" ]; then
            echo "âŒ Diagram too small (<100KB). Replace placeholder with high-res PNG."
            if [ "$STRICT_MODE" = "true" ]; then exit 1; fi
          else
            echo "âœ… Diagram passes size check"
          fi
        fi
    
    - name: ğŸ“¤ Upload Architecture Validation Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: architecture-validation-results
        path: |
          docs/images/universal_ai_router_architecture.png
        if-no-files-found: ignore
        retention-days: 30

  # Job 6: Validation Summary
  validation_summary:
    name: ğŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [workflow_validation, code_quality_validation, security_validation, web_validation, architecture_validation]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        pattern: '*'
        merge-multiple: true
    
    - name: ğŸ“Š Generate Summary
      run: |
        echo "ğŸ“Š Generating Validation Layer Summary"
        
        cat > validation_summary.md << EOF
        # ğŸ“Š Core-3: Validation Layer Summary
        
        ## ğŸ“ˆ **VALIDATION OVERVIEW**
        - **Validation Mode**: ${{ env.VALIDATION_MODE }}
        - **Strict Mode**: ${{ env.STRICT_MODE }}
        - **Timestamp**: $(date)
        - **Repository**: ${{ github.repository }}
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        
        ## âœ… **VALIDATION STATUS**
        - **Workflow Validation**: ${{ needs.workflow_validation.result }}
        - **Code Quality**: ${{ needs.code_quality_validation.result }}
        - **Security Scan**: ${{ needs.security_validation.result }}
        - **Web CI**: ${{ needs.web_validation.result }}
        - **Architecture**: ${{ needs.architecture_validation.result }}
        
        ## ğŸ“¦ **VALIDATION RESULTS**
        - Workflow validation results
        - Code quality reports
        - Security scan reports
        - Web CI test results
        - Architecture validation results
        
        ## ğŸ¯ **NEXT STEPS**
        1. Review all validation results
        2. Fix any identified issues
        3. Address security vulnerabilities
        4. Update documentation as needed
        
        ---
        *Generated by Core-3: Validation Layer - Consolidated from 4 workflows*
        EOF
        
        echo "âœ… Validation summary generated"
    
    - name: ğŸ“¤ Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: validation-summary
        path: validation_summary.md
        retention-days: 90
    
    - name: ğŸ“ Create Summary Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('validation_summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

