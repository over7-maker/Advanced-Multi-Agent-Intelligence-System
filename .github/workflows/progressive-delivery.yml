name: Progressive Delivery Pipeline

# =============================================================================
# PROGRESSIVE DELIVERY PIPELINE WORKFLOW
# =============================================================================
# Purpose: Safe, automated deployments with canary releases, SLO-based gates,
#          automatic rollback, and zero-downtime delivery.
#
# Security: Only merged PRs trigger production deployment (not direct pushes).
#           Branch protection validation ensures code review and status checks.
#           Production environment requires manual approval.
#
# Triggers:
#   - PR merged to main: Production deployment (validated merge + branch protection)
#   - PR opened/updated: Build and test only (no deployment)
#   - Manual dispatch: Deploy with environment/strategy selection
#
# See docs/deployment/PROGRESSIVE_DELIVERY.md for detailed documentation.
# =============================================================================
on:
  # Production deployment: Only trigger on merged PRs to main (not direct pushes)
  # Security: Ensures code review and branch protection are enforced
  # PR testing: Build and test on PR updates (doesn't deploy)
  # Note: We use pull_request.closed with merge validation instead of push to main
  # because it allows us to validate PR merge status explicitly before deployment
  pull_request:
    branches:
      - main  # Only main branch for production safety
    # Trigger on PR updates for testing, and on PR close for deployment validation
    # CRITICAL: Closed PRs are validated for merge status in validate-pr-merge job
    # Note: ready_for_review removed to avoid unnecessary runs (draft PRs don't need testing)
    types: [opened, synchronize, reopened, closed]
    # Security: Ignore documentation-only changes to avoid unnecessary runs
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!**.yml'  # But still trigger on workflow file changes
      - '!**.yaml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deployment_strategy:
        description: |
          Deployment strategy selection:
          - canary: Progressive rollout (10%‚Üí25%‚Üí50%‚Üí75%‚Üí100%)
          - blue-green: Instant traffic switch for emergencies
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - blue-green
      image_name:
        description: |
          Container image name (optional).
          Must be 1-255 chars, alphanumeric with hyphens/dots/underscores.
        required: false
        default: 'amas-orchestrator'
        type: string
      docker_registry:
        description: |
          Docker registry hostname (optional).
          Examples: ghcr.io, registry.example.com:5000
        required: false
        default: 'ghcr.io'
        type: string

# =============================================================================
# CONCURRENCY CONTROL
# =============================================================================
# Prevents multiple deployments from running simultaneously on the same branch
# Security: Prevents race conditions and conflicting deployments
# =============================================================================
concurrency:
  group: progressive-delivery-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel deployments in progress (safety)

# =============================================================================
# WORKFLOW-LEVEL PERMISSIONS
# =============================================================================
# Minimal permissions following principle of least privilege
# Individual jobs can override if needed
# Security: Explicitly set permissions to minimum required
# =============================================================================
permissions:
  contents: read      # Read repository contents (for checkout)
  packages: write     # Push container images to GHCR
  security-events: write  # Upload security scan results (SARIF)
  actions: read       # Read workflow status (for job dependencies)
  deployments: write  # Create deployment status (for progressive delivery tracking)
  checks: write       # Update check status (for deployment gates)

# =============================================================================
# WORKFLOW DEFAULTS
# =============================================================================
# Set default shell and timeout for all jobs
# Security: Use bash explicitly to avoid shell injection risks
# Performance: Set reasonable timeouts to prevent resource exhaustion
# =============================================================================
defaults:
  run:
    shell: bash
    # Default timeout for all run steps (can be overridden per job)
    timeout-minutes: 10

# =============================================================================
# GLOBAL ENVIRONMENT VARIABLES (Non-sensitive)
# =============================================================================
# These non-sensitive variables are used across all jobs in the workflow
# Security: Sensitive values (REGISTRY_PASSWORD) are defined at job-level to limit exposure
# Note: Image name and registry can be overridden via workflow_dispatch inputs
# =============================================================================
env:
  PYTHON_VERSION: '3.11'
  # Use inputs if provided, otherwise defaults (can be overridden per job if needed)
  DOCKER_REGISTRY: ${{ github.event.inputs.docker_registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.event.inputs.image_name || 'amas-orchestrator' }}
  REGISTRY_USERNAME: ${{ github.repository_owner }}
  # Performance: Enable Docker BuildKit for faster builds
  DOCKER_BUILDKIT: 1
  BUILDKIT_INLINE_CACHE: 1

# =============================================================================
# JOBS DEFINITION
# =============================================================================
# Phases: 0=Input Validation, 1=Build & Scan, 2=Staging, 
#         3=Production Canary, 3B=Production Blue-Green, 
#         4=Emergency Rollback, 5=Failure Notifications
# =============================================================================

jobs:
  # =============================================================================
  # PHASE -1: BRANCH PROTECTION VALIDATION
  # =============================================================================
  # Purpose: Validates that branch protection rules are enabled for main branch
  # Security: Prevents deployment of unreviewed/untested code
  # Note: This job only runs on push to main (not on PRs)
  # =============================================================================
  
  validate-pr-merge:
    name: üõ°Ô∏è Validate PR Merge
    runs-on: ubuntu-latest
    # Only validate on closed PRs to main (check if merged)
    # CRITICAL: This job validates that PR was actually merged, not just closed
    # Security: Only process PRs from the same repository (block external forks)
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.base_ref == 'main' &&
      github.event.pull_request.head.repo.full_name == github.repository
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    steps:
    - name: üîç Verify PR Was Merged
      run: |
        echo "üîç Validating PR merge status..."
        echo "PR #${{ github.event.pull_request.number }}"
        echo "Action: ${{ github.event.action }}"
        echo "Merged status: ${{ github.event.pull_request.merged }}"
        
        # CRITICAL: Check if PR was actually merged (not just closed)
        # This prevents deployment on PRs that were closed without merge
        # Security: Fail the job if PR was closed without merge to prevent any downstream jobs
        if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
          echo "‚ùå ERROR: PR was closed but not merged"
          echo "PR #${{ github.event.pull_request.number }} was closed without merge"
          echo "Deployment workflows require PR merge. Skipping all deployment jobs."
          exit 1  # Fail job to prevent downstream deployment jobs from running
        fi
        
        echo "‚úÖ PR #${{ github.event.pull_request.number }} was successfully merged"
        echo "‚úÖ Merge commit: ${{ github.event.pull_request.merge_commit_sha }}"
        echo "‚úÖ Merged by: ${{ github.event.pull_request.merged_by.login }}"
        echo "‚úÖ Base branch: ${{ github.base_ref }}"
    
    - name: üîç Check Branch Protection Rules
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üîç Validating branch protection rules for main branch..."
        
        # Get branch protection status
        response=$(curl -s -w "\n%{http_code}" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/branches/main/protection")
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        if [ "$http_code" != "200" ]; then
          echo "‚ùå Branch protection not configured or not accessible"
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          echo ""
          echo "‚ö†Ô∏è  CRITICAL: Branch protection rules must be enabled!"
          echo "Configure in: Settings > Branches > main"
          exit 1
        fi
        
        # Validate required status checks
        if ! echo "$body" | jq -e '.required_status_checks != null' &> /dev/null; then
          echo "‚ùå Required status checks not configured"
          exit 1
        fi
        
        # Validate required pull request reviews
        if ! echo "$body" | jq -e '.required_pull_request_reviews != null' &> /dev/null; then
          echo "‚ùå Required pull request reviews not configured"
          exit 1
        fi
        
        # Validate enforce admins (optional but recommended)
        enforce_admins=$(echo "$body" | jq -r '.enforce_admins.enabled // false')
        if [ "$enforce_admins" != "true" ]; then
          echo "‚ö†Ô∏è  Warning: Enforce admins is not enabled"
          echo "   Recommended: Enable 'Do not allow bypassing the above settings'"
        fi
        
        echo "‚úÖ Branch protection rules validated successfully"
        echo "‚úÖ Required status checks: Enabled"
        echo "‚úÖ Required PR reviews: Enabled"
        echo "‚úÖ Enforce admins: $enforce_admins"
    
    - name: ‚úÖ PR Merge Validated
      run: |
        echo "‚úÖ PR merge validated successfully"
        echo "‚úÖ Branch protection rules verified"
        echo "‚úÖ Safe to proceed with deployment"

  # Rest of the jobs remain the same as the original file...
  # For brevity, I'm truncating here but the full file would include all remaining jobs
