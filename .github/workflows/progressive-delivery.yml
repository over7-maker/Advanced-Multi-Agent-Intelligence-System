name: Progressive Delivery Pipeline

# Section: Workflow Overview
# Purpose: Safe, automated deployments with canary releases, SLO-based gates,
#          automatic rollback, and zero-downtime delivery.
#
# Security: Only merged PRs trigger production deployment (not direct pushes).
#           Branch protection validation ensures code review and status checks.
#           Production environment requires manual approval.
#
# Triggers:
#   - PR merged to main: Production deployment (validated merge + branch protection)
#   - PR opened/updated: Build and test only (no deployment)
#   - Manual dispatch: Deploy with environment/strategy selection
#
# See docs/deployment/PROGRESSIVE_DELIVERY.md for detailed documentation.

on:
  # Section: Pull Request Events
  # Important: Deployment only proceeds if merged PR is confirmed via validate-pr-merge
  # Security: Ensures code review and branch protection are enforced
  # Note: We use pull_request.closed with merge validation instead of push to main
  #       because it allows us to validate PR merge status explicitly before deployment
  pull_request:
    branches:
      - main  # Only main branch for production safety
    # Trigger on PR updates for testing, and on PR close for deployment validation
    types: [opened, synchronize, reopened, closed]
    # Performance: Skip runs for documentation-only changes
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
    # Security: Still trigger on workflow file changes (override ignore)
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'k8s/**'
      - 'scripts/**'
      - 'Dockerfile'
      - 'requirements.txt'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deployment_strategy:
        description: |
          Deployment strategy selection:
          - canary: Progressive rollout (10%â†’25%â†’50%â†’75%â†’100%)
          - blue-green: Instant traffic switch for emergencies
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - blue-green
      image_name:
        description: |
          Container image name (optional).
          Must be 1-255 chars, alphanumeric with hyphens/dots/underscores.
        required: false
        default: 'amas-orchestrator'
        type: string
      docker_registry:
        description: |
          Docker registry hostname (optional).
          Examples: ghcr.io, registry.example.com:5000
        required: false
        default: 'ghcr.io'
        type: string

# Section: Concurrency Control
# Performance: Cancel outdated PR runs to save resources
# Security: Prevents race conditions and conflicting deployments
concurrency:
  group: progressive-delivery-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}  # Cancel outdated PR runs

# Section: Workflow Permissions
# Security: Minimal permissions following principle of least privilege
# Individual jobs can escalate if needed with job-level permissions
permissions:
  contents: read       # Read repository contents (for checkout)
  packages: write      # Push container images to GHCR
  security-events: write  # Upload security scan results (SARIF)
  actions: read        # Read workflow status (for job dependencies)
  deployments: write   # Create deployment status (for progressive delivery tracking)
  checks: write        # Update check status (for deployment gates)
  pull-requests: read  # Read PR status for merge validation

# Section: Workflow Defaults
# Security: Use bash explicitly to avoid shell injection risks
# Performance: Set reasonable timeouts to prevent resource exhaustion
defaults:
  run:
    shell: bash

# Section: Global Environment Variables
# Note: Sensitive values (REGISTRY_PASSWORD) are defined at job-level to limit exposure
env:
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ${{ github.event.inputs.docker_registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.event.inputs.image_name || 'amas-orchestrator' }}
  REGISTRY_USERNAME: ${{ github.repository_owner }}
  DOCKER_BUILDKIT: 1
  BUILDKIT_INLINE_CACHE: 1

# Section: Jobs Definition
# Flow: validation â†’ build â†’ staging â†’ production â†’ rollback (on failure)

jobs:
  # Phase -1: Branch Protection Validation
  validate-pr-merge:
    name: ðŸ›¡ï¸ Validate PR Merge
    runs-on: ubuntu-latest
    # Security: Only validate on closed PRs that are actually merged
    # This ensures unmerged PRs never trigger deployments
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.base_ref == 'main' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.repo.full_name == github.repository
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    steps:
    - name: ðŸ” Verify PR Was Merged
      run: |
        echo "ðŸ” Validating PR merge status..."
        echo "PR #${{ github.event.pull_request.number }}"
        echo "Action: ${{ github.event.action }}"
        echo "Merged status: ${{ github.event.pull_request.merged }}"
        
        # Security: Double-check merge status to prevent accidental deployments
        if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
          echo "âŒ ERROR: PR was closed but not merged"
          exit 1
        fi
        
        # Security: Verify PR came from same repository (block external forks)
        if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
          echo "âŒ ERROR: PR from external fork not allowed"
          exit 1
        fi
        
        echo "âœ… PR #${{ github.event.pull_request.number }} was successfully merged"
        echo "âœ… Merge commit: ${{ github.event.pull_request.merge_commit_sha }}"
        echo "âœ… Merged by: ${{ github.event.pull_request.merged_by.login }}"
        echo "âœ… Base branch: ${{ github.base_ref }}"
    
    - name: ðŸ” Check Branch Protection Rules
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Validating branch protection rules for main branch..."
        
        response=$(curl -s -w "\n%{http_code}" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/branches/main/protection")
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        if [ "$http_code" != "200" ]; then
          echo "âŒ Branch protection not configured or not accessible"
          exit 1
        fi
        
        if ! echo "$body" | jq -e '.required_status_checks != null' &> /dev/null; then
          echo "âŒ Required status checks not configured"
          exit 1
        fi
        
        if ! echo "$body" | jq -e '.required_pull_request_reviews != null' &> /dev/null; then
          echo "âŒ Required pull request reviews not configured"
          exit 1
        fi
        
        echo "âœ… Branch protection rules validated successfully"
        echo "âœ… Required status checks: Enabled"
        echo "âœ… Required PR reviews: Enabled"

  # Phase 0: Input Validation (for workflow_dispatch)
  validate-inputs:
    name: âœ… Validate Workflow Inputs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch'
    steps:
    - name: âœ… Validate environment input
      run: |
        ENV="${{ github.event.inputs.environment }}"
        if [[ -z "$ENV" ]]; then
          echo "âŒ Environment input is required"
          exit 1
        fi
        if [[ "$ENV" != "staging" && "$ENV" != "production" ]]; then
          echo "âŒ Invalid environment input: $ENV"
          echo "âŒ Must be 'staging' or 'production'"
          exit 1
        fi
        echo "âœ… Environment input valid: $ENV"
    
    - name: âœ… Validate deployment strategy input
      run: |
        STRATEGY="${{ github.event.inputs.deployment_strategy }}"
        if [[ -z "$STRATEGY" ]]; then
          echo "âŒ Deployment strategy input is required"
          exit 1
        fi
        if [[ "$STRATEGY" != "canary" && "$STRATEGY" != "blue-green" ]]; then
          echo "âŒ Invalid deployment strategy: $STRATEGY"
          echo "âŒ Must be 'canary' or 'blue-green'"
          exit 1
        fi
        echo "âœ… Deployment strategy input valid: $STRATEGY"
    
    - name: âœ… Validate image_name format
      run: |
        IMAGE="${{ github.event.inputs.image_name }}"
        if [[ -n "$IMAGE" ]]; then
          # Security: Validate format to prevent injection
          if ! [[ "$IMAGE" =~ ^[a-zA-Z0-9._-]{1,255}$ ]]; then
            echo "âŒ Invalid image_name format: $IMAGE"
            echo "âŒ Must be 1-255 chars, alphanumeric with hyphens/dots/underscores"
            exit 1
          fi
        fi
        echo "âœ… Image name format valid: ${IMAGE:-default}"
    
    - name: âœ… Validate docker_registry format
      run: |
        REGISTRY="${{ github.event.inputs.docker_registry }}"
        if [[ -n "$REGISTRY" ]]; then
          # Security: Validate hostname format
          if ! [[ "$REGISTRY" =~ ^[a-zA-Z0-9.-]+(:[0-9]+)?$ ]]; then
            echo "âŒ Invalid docker_registry format: $REGISTRY"
            echo "âŒ Must be a valid hostname or hostname:port"
            exit 1
          fi
        fi
        echo "âœ… Docker registry format valid: ${REGISTRY:-default}"

  # Phase 1: Build & Security Scan
  build-and-security-scan:
    name: ðŸ³ Build & Security Scan
    runs-on: ubuntu-latest
    # Security: Only process PRs from the same repository (block external forks)
    if: |
      (github.event_name == 'pull_request' && 
       github.event.pull_request.head.repo.full_name == github.repository) ||
      github.event_name == 'workflow_dispatch'
    needs: 
      - validate-inputs
      - validate-pr-merge
    # Run if validation passed or was skipped (not workflow_dispatch or not PR)
    if: |
      always() && 
      (needs.validate-inputs.result == 'success' || needs.validate-inputs.result == 'skipped') &&
      (needs.validate-pr-merge.result == 'success' || needs.validate-pr-merge.result == 'skipped')
    timeout-minutes: 45
    permissions:
      contents: read
      packages: write
      security-events: write
    env:
      REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.build.outputs.tags }}
      image-full: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
          network=host
    
    - name: ðŸ”‘ Login to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ env.REGISTRY_USERNAME }}
        password: ${{ env.REGISTRY_PASSWORD }}
    
    - name: ðŸ—ï¸ Build Docker image
      id: build
      uses: docker/build-push-action@v5
      continue-on-error: ${{ github.event_name == 'pull_request' }}
      env:
        DOCKER_BUILDKIT: 1
        BUILDKIT_PROGRESS: plain
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: ${{ github.event_name != 'pull_request' }}
        sbom: ${{ github.event_name != 'pull_request' }}
    
    - name: ðŸ” Container security scan with Trivy
      if: steps.build.outcome == 'success' && github.event_name != 'pull_request'
      continue-on-error: true
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'
    
    - name: ðŸ“Š Upload Trivy scan results
      if: always() && steps.build.outcome == 'success'
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true
      with:
        sarif_file: 'trivy-results.sarif'
        retention-days: 30

  # Phase 2: Staging Deployment
  deploy-staging:
    name: ðŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-security-scan]
    if: always() && !cancelled() && needs.build-and-security-scan.result != 'failure'
    environment: staging
    timeout-minutes: 20
    permissions:
      contents: read
    continue-on-error: true
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: ðŸ”§ Setup Argo Rollouts CLI
      run: |
        curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
        chmod +x kubectl-argo-rollouts-linux-amd64
        sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
    
    - name: ðŸ”‘ Configure Kubernetes
      run: |
        if [ -z "${{ secrets.KUBECONFIG_STAGING }}" ]; then
          echo "âš ï¸  KUBECONFIG_STAGING secret not set, skipping staging deployment"
          exit 0
        fi
        
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config || exit 1
        kubectl version --client || exit 1
        kubectl create namespace amas-staging --dry-run=client -o yaml | kubectl apply -f - || true
        kubectl config set-context --current --namespace=amas-staging
    
    - name: ðŸ“‹ Check Argo Rollouts Installation
      run: |
        if ! kubectl get crd rollouts.argoproj.io &> /dev/null; then
          echo "SKIP_ARGO_ROLLOUTS=true" >> $GITHUB_ENV
        else
          echo "SKIP_ARGO_ROLLOUTS=false" >> $GITHUB_ENV
        fi
    
    - name: ðŸš€ Deploy to staging
      run: |
        export NAMESPACE=amas-staging
        export ROLLOUT_NAME=amas-orchestrator
        export IMAGE_TAG=${{ github.sha }}
        export DOCKER_REGISTRY="${{ env.DOCKER_REGISTRY }}"
        export IMAGE_NAME="${{ env.IMAGE_NAME }}"
        
        if kubectl get rollout amas-orchestrator -n amas-staging &> /dev/null; then
          kubectl set image rollout/amas-orchestrator orchestrator="${DOCKER_REGISTRY}/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}" -n amas-staging
        elif kubectl get deployment amas-orchestrator -n amas-staging &> /dev/null; then
          kubectl set image deployment/amas-orchestrator orchestrator="${DOCKER_REGISTRY}/${{ github.repository_owner }}/${IMAGE_NAME}:${IMAGE_TAG}" -n amas-staging
        else
          echo "âš ï¸  No rollout or deployment found in staging"
          exit 0
        fi

  # Phase 3: Production Canary Deployment
  deploy-production-canary:
    name: ðŸŒŸ Production Canary Deployment
    runs-on: ubuntu-latest
    needs: [build-and-security-scan, deploy-staging, validate-pr-merge]
    if: |
      needs.build-and-security-scan.result == 'success' && (
        (github.event_name == 'pull_request' && 
         github.event.action == 'closed' && 
         github.event.pull_request.merged == true &&
         github.base_ref == 'main' &&
         needs.validate-pr-merge.result == 'success') ||
        (github.event_name == 'workflow_dispatch' && 
         github.event.inputs.deployment_strategy == 'canary' &&
         github.event.inputs.environment == 'production')
      )
    environment: 
      name: production
      url: https://amas.example.com
    timeout-minutes: 30
    permissions:
      contents: read
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: ðŸ”§ Setup Argo Rollouts CLI
      run: |
        curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
        chmod +x kubectl-argo-rollouts-linux-amd64
        sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
    
    - name: ðŸ”‘ Configure Kubernetes
      run: |
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
        kubectl config set-context --current --namespace=amas-prod
    
    - name: ðŸ“‹ Apply Analysis Templates
      run: |
        if [ ! -f k8s/argo-rollouts/analysis-templates.yaml ]; then
          echo "âš ï¸  Analysis templates not found, skipping"
          exit 0
        fi
        kubectl apply -f k8s/argo-rollouts/analysis-templates.yaml || exit 0
    
    - name: ðŸ“‹ Apply Rollout Configuration
      run: |
        if [ ! -f k8s/argo-rollouts/rollout.yaml ]; then
          echo "âš ï¸  Rollout configuration not found, skipping"
          exit 0
        fi
        kubectl apply -f k8s/argo-rollouts/rollout.yaml
    
    - name: ðŸš€ Execute Canary Deployment
      run: |
        echo "ðŸš€ Starting canary deployment to production..."
        if [ ! -f scripts/deployment/canary_deploy.sh ]; then
          echo "âŒ Canary deployment script not found"
          exit 1
        fi
        
        chmod +x scripts/deployment/canary_deploy.sh
        ./scripts/deployment/canary_deploy.sh
    
    - name: ðŸ“Š Monitor Deployment
      run: |
        echo "ðŸ“Š Monitoring deployment progress..."
        kubectl rollout status rollout/amas-orchestrator -n amas-prod --timeout=10m || exit 0

  # Phase 3B: Production Blue-Green Deployment
  deploy-production-blue-green:
    name: ðŸ”µ Production Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: [build-and-security-scan, deploy-staging]
    if: |
      needs.build-and-security-scan.result == 'success' && (
        github.event_name == 'workflow_dispatch' && 
        github.event.inputs.deployment_strategy == 'blue-green' &&
        github.event.inputs.environment == 'production'
      )
    environment: 
      name: production
      url: https://amas.example.com
    timeout-minutes: 20
    permissions:
      contents: read
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: ðŸ”‘ Configure Kubernetes
      run: |
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
        kubectl config set-context --current --namespace=amas-prod
    
    - name: ðŸš€ Execute Blue-Green Deployment
      run: |
        echo "ðŸš€ Starting blue-green deployment to production..."
        if [ ! -f scripts/deployment/blue_green_deploy.sh ]; then
          echo "âŒ Blue-green deployment script not found"
          exit 1
        fi
        
        chmod +x scripts/deployment/blue_green_deploy.sh
        ./scripts/deployment/blue_green_deploy.sh deploy

  # Phase 4: Emergency Rollback
  emergency-rollback:
    name: ðŸ”„ Emergency Rollback
    runs-on: ubuntu-latest
    needs: [deploy-production-canary, deploy-production-blue-green]
    if: |
      failure() && (
        (needs.deploy-production-canary.result == 'failure') ||
        (needs.deploy-production-blue-green.result == 'failure')
      )
    environment: production
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: ðŸ”‘ Configure Kubernetes
      run: |
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
        kubectl config set-context --current --namespace=amas-prod
    
    - name: ðŸ”„ Execute Rollback
      run: |
        echo "ðŸ”„ Executing emergency rollback..."
        if ! kubectl get rollout amas-orchestrator -n amas-prod &> /dev/null; then
          echo "âš ï¸  Rollout not found, cannot rollback"
          exit 1
        fi
        
        kubectl rollout undo rollout/amas-orchestrator -n amas-prod
        kubectl rollout status rollout/amas-orchestrator -n amas-prod --timeout=5m

  # Phase 5: Failure Notifications
  notify-failure:
    name: ðŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-security-scan, deploy-staging, deploy-production-canary, deploy-production-blue-green]
    if: failure() && !cancelled()
    timeout-minutes: 5
    permissions:
      contents: read
    
    steps:
    - name: ðŸ“¢ Generate failure report
      run: |
        echo "## ðŸš¨ Workflow Failure Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** Progressive Delivery Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Failed Jobs:" >> $GITHUB_STEP_SUMMARY
        echo "- Build & Security Scan: ${{ needs.build-and-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Staging: ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Production Canary: ${{ needs.deploy-production-canary.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Production Blue-Green: ${{ needs.deploy-production-blue-green.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review workflow logs for detailed error information" >> $GITHUB_STEP_SUMMARY
        echo "2. Check if emergency rollback was triggered" >> $GITHUB_STEP_SUMMARY
        echo "3. Verify deployment status in Kubernetes cluster" >> $GITHUB_STEP_SUMMARY
