name: ðŸ” Workflow Audit Monitor

on:
  schedule:
    - cron: '0 0 1 * *'  # First day of every month
  workflow_dispatch:
    inputs:
      audit_type:
        description: 'Audit Type'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - syntax-check
          - integration-check
          - performance-check

env:
  PYTHON_VERSION: '3.11'
  AUDIT_TYPE: ${{ github.event.inputs.audit_type || 'comprehensive' }}

jobs:
  audit_workflows:
    name: ðŸ” Workflow Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        set -e  # Exit on any error
        set -o pipefail  # Exit on pipe errors
        python -m pip install --upgrade pip
        pip install pyyaml requests
    
    - name: ðŸ” Run Comprehensive Workflow Audit
      id: workflow_audit
      run: |
        set -e  # Exit on any error
        set -o pipefail  # Exit on pipe errors
        echo "ðŸ” Starting Comprehensive Workflow Audit"
        echo "Audit Type: $AUDIT_TYPE"
        echo ""
        
        # Run workflow audit
        python .github/scripts/workflow_audit_monitor.py \
          --audit-type $AUDIT_TYPE \
          --output workflow_audit_results.json
        
        echo "âœ… Workflow audit completed"
    
    - name: ðŸ“Š Generate Audit Report
      id: audit_report
      needs: workflow_audit
      run: |
        set -e  # Exit on any error
        set -o pipefail  # Exit on pipe errors
        echo "ðŸ“Š Generating Audit Report"
        echo ""
        
        # Create comprehensive audit report
        cat > workflow_audit_report.md << 'EOF'
        # ðŸ” Workflow Audit Report
        
        ## ðŸ“Š **AUDIT OVERVIEW**
        - **Audit Type**: $AUDIT_TYPE
        - **Timestamp**: $(date)
        - **Repository**: ${{ github.repository }}
        - **Branch**: ${{ github.ref_name }}
        
        ## ðŸ” **AUDIT FINDINGS**
        - **Total Workflows**: [See audit results]
        - **Valid Workflows**: [See audit results]
        - **Broken Workflows**: [See audit results]
        - **Legacy Workflows**: [See audit results]
        - **API Manager Usage**: [See audit results]
        
        ## ðŸ“ˆ **PERFORMANCE METRICS**
        - **Audit Duration**: ${{ github.run_duration }}
        - **Success Rate**: [See audit results]
        - **Issues Found**: [See audit results]
        - **Recommendations**: [See audit results]
        
        ## ðŸŽ¯ **NEXT STEPS**
        1. Review audit findings
        2. Fix identified issues
        3. Update workflows as needed
        4. Schedule next audit cycle
        
        ---
        *Generated by Workflow Audit Monitor*
        EOF
        
        echo "âœ… Audit report generated"
    
    - name: ðŸ“¤ Upload Audit Results
      uses: actions/upload-artifact@v4
      with:
        name: workflow-audit-results
        path: |
          workflow_audit_results.json
          workflow_audit_report.md
        retention-days: 90
    
    - name: ðŸ“ Create Audit Summary Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read the audit report
          const report = fs.readFileSync('workflow_audit_report.md', 'utf8');
          
          // Create comment
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
    
    - name: ðŸ·ï¸ Add Audit Labels
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          // Add audit labels
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['workflow-audited', 'system-health-check', 'automated-review']
          });