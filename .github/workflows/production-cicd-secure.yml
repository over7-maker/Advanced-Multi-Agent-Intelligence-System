name: üöÄ AMAS Secure Production CI/CD Pipeline

# Least-privilege defaults; elevate per job only when needed
permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
      skip_tests:
        description: 'Skip non-critical tests (security tests always run)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11.13'
  NODE_VERSION: '20'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: amas
  REGISTRY_USERNAME: ${{ github.repository_owner }}

jobs:
  security-scan:
    name: üîí Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: security-scan-${{ github.ref }}-${{ github.event.inputs.environment || 'push' }}
      cancel-in-progress: true
    outputs:
      vulnerabilities-found: ${{ steps.scan-results.outputs.vulnerabilities }}
      critical-vulnerabilities: ${{ steps.scan-results.outputs.critical-vulnerabilities }}
      passed: ${{ steps.scan-results.outputs.passed }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-security.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - run: mkdir -p ~/.cache/pip
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-security.txt
      - name: Safety
        continue-on-error: true
        run: |
          set -o pipefail
          # Run safety and capture output and exit code properly
          safety check --json > safety-report.json 2>&1
          exit_code=$?
          # Validate JSON output
          if ! jq empty safety-report.json 2>jq-error.log; then
            echo "‚ö†Ô∏è  JSON validation failed: $(cat jq-error.log 2>/dev/null || echo 'invalid JSON')"
            echo "‚ö†Ô∏è  Creating empty Safety report"
            echo "[]" > safety-report.json
            exit_code=64
          fi
          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ Safety scan completed, no vulnerabilities"
          elif [ $exit_code -eq 1 ]; then
            echo "‚ö†Ô∏è  Safety found vulnerabilities (see safety-report.json)"
          else
            echo "‚ö†Ô∏è  Safety check failed with exit code $exit_code (database/API issue - continuing)"
            echo "[]" > safety-report.json
          fi
      - name: Bandit
        continue-on-error: true
        env:
          SCAN_TARGET: src
        run: |
          set -o pipefail
          if [ -d "$SCAN_TARGET" ]; then
            # Run bandit and capture exit code properly
            bandit -r "$SCAN_TARGET" -f json -o bandit-report.json 2>&1
            exit_code=$?
            # Validate JSON output
            if ! jq empty bandit-report.json 2>jq-error.log; then
              echo "‚ö†Ô∏è  JSON validation failed: $(cat jq-error.log 2>/dev/null || echo 'invalid JSON')"
              echo "‚ö†Ô∏è  Creating empty Bandit report"
              echo '{"results":[],"generated_at":"'"$(date -Iseconds)"'","metadata":{"bandit_version":"unknown"}}' > bandit-report.json
              exit_code=2
            fi
            if [ $exit_code -eq 0 ]; then
              echo "‚úÖ Bandit scan completed, no issues found"
            elif [ $exit_code -eq 1 ]; then
              echo "‚ö†Ô∏è  Bandit found issues (see bandit-report.json)"
            else
              echo "‚ö†Ô∏è  Bandit check failed with exit code $exit_code (execution error - continuing)"
              echo '{"results":[],"generated_at":"'"$(date -Iseconds)"'","metadata":{"bandit_version":"unknown"}}' > bandit-report.json
            fi
          else
            echo "‚ÑπÔ∏è  Directory '$SCAN_TARGET' not found ‚Äî skipping Bandit scan"
            echo '{"results":[],"generated_at":"'"$(date -Iseconds)"'","metadata":{"bandit_version":"unknown"}}' > bandit-report.json
          fi
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
      - name: Generate SARIF report
        run: |
          # Generate SARIF report using installed semgrep
          if command -v semgrep >/dev/null 2>&1 || python -m semgrep --version >/dev/null 2>&1; then
            python -m semgrep scan \
              --sarif \
              --output=semgrep.sarif \
              --config=p/security-audit \
              --config=p/secrets \
              --config=p/owasp-top-ten \
              --timeout=300 || true
          else
            echo "‚ö†Ô∏è  Semgrep not available, creating empty SARIF"
            echo '{"version": "2.1.0", "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json", "runs": [{"results": []}]}' > semgrep.sarif
          fi
        continue-on-error: true
      - name: Semgrep CI
        run: |
          # Semgrep CI requires authentication, skip if not available
          if [ -n "${{ secrets.SEMGREP_APP_TOKEN }}" ]; then
            python -m semgrep ci --sarif --output=semgrep-ci.sarif || true
          else
            echo "‚ö†Ô∏è  SEMGREP_APP_TOKEN not set, skipping Semgrep CI scan"
            echo '{"version": "2.1.0", "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json", "runs": [{"results": []}]}' > semgrep-ci.sarif || true
          fi
        continue-on-error: true
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('semgrep.sarif') != ''
        with:
          sarif_file: semgrep.sarif
      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            safety-report.json
            bandit-report.json
            semgrep.sarif
            semgrep-ci.sarif
          retention-days: 30
      - name: Evaluate
        id: scan-results
        run: |
          vuln=0
          crit=0
          # Initialize empty JSON files if they don't exist
          [ ! -f safety-report.json ] && echo "[]" > safety-report.json || true
          [ ! -f bandit-report.json ] && echo '{"results":[]}' > bandit-report.json || true
          # Count vulnerabilities from Safety
          if [ -s safety-report.json ]; then
            v=$(jq 'if type=="array" then length else 0 end' safety-report.json 2>/dev/null || echo 0)
            vuln=$((vuln+v))
          fi
          # Count vulnerabilities from Bandit
          if [ -s bandit-report.json ]; then
            b=$(jq '.results|length' bandit-report.json 2>/dev/null || echo 0)
            vuln=$((vuln+b))
            # Count critical/high severity issues
            crit=$(jq '[.results[] | select(.issue_severity=="HIGH" or .issue_severity=="CRITICAL")] | length' bandit-report.json 2>/dev/null || echo 0)
          fi
          echo "vulnerabilities=$vuln" >> $GITHUB_OUTPUT
          echo "critical-vulnerabilities=$crit" >> $GITHUB_OUTPUT
          echo "passed=$([ "$crit" -eq 0 ] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "üìä Found $vuln total vulnerabilities, $crit critical"
          
          # Fail the job if critical vulnerabilities are found
          if [ "$crit" -gt 0 ]; then
            echo "‚ùå Security scan FAILED: Found $crit critical vulnerabilities"
            exit 1
          elif [ "$vuln" -gt 10 ]; then
            echo "‚ö†Ô∏è  Security scan WARNING: Found $vuln total vulnerabilities (threshold: 10)"
            echo "‚ö†Ô∏è  Consider reviewing and fixing vulnerabilities before merging"
          else
            echo "‚úÖ Security scan PASSED: $vuln total vulnerabilities, $crit critical"
          fi
          
          # Additional enforcement: Check Safety for critical vulnerabilities
          if [ -s safety-report.json ]; then
            safety_critical=$(jq '[.[] | select(.severity == "CRITICAL" or .severity == "HIGH")] | length' safety-report.json 2>/dev/null || echo 0)
            if [ "$safety_critical" -gt 0 ]; then
              echo "‚ùå Safety found $safety_critical critical/high severity vulnerabilities"
              exit 1
            fi
          fi
