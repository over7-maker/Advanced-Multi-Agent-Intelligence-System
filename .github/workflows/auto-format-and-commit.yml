name: 🧹 Auto Format and Commit (Black/isort)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: 'Paths to format (default: src tests)'
        required: false
        default: 'src tests'
      python-version:
        description: 'Python version for Black/isort'
        required: false
        default: '3.11'
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-format:
    # Security: Only allow trusted actors and prevent fork abuse
    # Note: Won't re-trigger on its own commits because label must be manually added
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.label.name == 'auto-format' &&
       github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      # Use PR number for PRs, ref for other events (better isolation)
      group: auto-format-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: ${{ github.event.inputs.python-version || '3.11' }}
          cache: 'pip'

      - name: 📦 Install formatters
        run: |
          # Security: isort >=5.13.2 fixes CVE-2023-38995 (command injection)
          pip install black==24.3.0 isort==5.13.2

      - name: 🎨 Run Black
        shell: bash
        run: |
          set -e
          TARGETS="${{ github.event.inputs.paths || 'src tests' }}"
          echo "Formatting: $TARGETS"
          if [ -f pyproject.toml ]; then
            black $TARGETS || exit 1
          else
            black $TARGETS --line-length 88 || exit 1
          fi

      - name: 🔀 Run isort
        shell: bash
        run: |
          set -e
          TARGETS="${{ github.event.inputs.paths || 'src tests' }}"
          echo "Sorting imports: $TARGETS"
          if [ -f pyproject.toml ]; then
            isort $TARGETS || exit 1
          else
            isort $TARGETS --profile black || exit 1
          fi

      - name: ⚙️ Configure Git
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ensure remote URL is set for pushing
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Determine branch name (for PRs use head_ref, otherwise use ref name)
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          
          # If in detached HEAD, checkout the branch properly
          if [ "$(git rev-parse --abbrev-ref HEAD)" = "HEAD" ]; then
            git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          fi
          
          # Fetch the branch from remote to ensure it exists locally
          git fetch origin "$BRANCH_NAME:$BRANCH_NAME" || true

      - name: 📝 Check for changes
        id: check-changes
        run: |
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "📝 Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✅ No changes detected"
          fi

      - name: 🧾 Commit formatting changes
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5.0.0
        with:
          commit_message: "chore: auto-format code with Black and isort"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          file_pattern: |
            **/*.py
            pyproject.toml
            setup.cfg

      - name: ✅ Summary
        if: always()
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Code formatted and committed successfully!"
            echo "🔄 CI checks should now run automatically on this commit."
          else
            echo "ℹ️  No formatting changes were needed. Code is already formatted."
          fi
