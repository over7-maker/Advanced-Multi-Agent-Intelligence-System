name: üßπ Auto Format and Commit (Black/isort)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: 'Paths to format (default: src tests)'
        required: false
        default: 'src tests'
      python-version:
        description: 'Python version for Black/isort'
        required: false
        default: '3.11'
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-format:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.label.name == 'auto-format')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: auto-format-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: ${{ github.event.inputs.python-version || '3.11' }}
          cache: 'pip'

      - name: üì¶ Install formatters
        run: |
          python -m pip install --upgrade pip
          pip install black==23.11.0 isort==5.12.0

      - name: üé® Run Black
        run: |
          set -e
          TARGETS="${{ github.event.inputs.paths || 'src tests' }}"
          echo "Formatting: $TARGETS"
          if [ -f pyproject.toml ]; then
            black $TARGETS
          else
            black $TARGETS --line-length 88
          fi

      - name: üîÄ Run isort
        run: |
          set -e
          TARGETS="${{ github.event.inputs.paths || 'src tests' }}"
          if [ -f pyproject.toml ]; then
            isort $TARGETS
          else
            isort $TARGETS --profile black
          fi

      - name: üßæ Commit formatting changes
        uses: stefanzweifel/git-auto-commit-action@v5.0.2
        with:
          commit_message: "chore: auto-format code with Black and isort"
          commit_user_name: amas-bot
          commit_user_email: amas-bot@users.noreply.github.com
          push_options: '--no-verify'
          skip_fetch: true
          file_pattern: |
            **/*.py
            pyproject.toml
            setup.cfg

      - name: ‚úÖ Summary
        run: |
          echo "Auto-format completed. If changes were committed, re-run failing workflows."
