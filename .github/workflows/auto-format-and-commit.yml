name: üßπ Auto Format and Commit (Black/isort)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: 'Paths to format (default: src tests)'
        required: false
        default: 'src tests'
      python-version:
        description: 'Python version for Black/isort'
        required: false
        default: '3.11'
  pull_request:
    types: [labeled]

permissions:
  contents: write  # Required to push formatted code back to PR branch
  pull-requests: write  # Required to comment on PR after formatting

jobs:
  auto-format:
    # Security: Only allow trusted actors and prevent fork abuse
    # Note: Won't re-trigger on its own commits because label must be manually added
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.action == 'labeled' &&
       github.event.label &&
       github.event.label.name == 'auto-format' &&
       github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      # Use PR number for PRs, run_id for workflow_dispatch (better isolation)
      # Use fixed workflow ID (sanitized) - workflow name has emojis/spaces that break group names
      group: auto-format-workflow-${{ github.event.pull_request.number || github.run_id }}
      cancel-in-progress: true
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.head_ref || github.ref }}
          # fetch-depth: 0 needed for git push to work correctly with branch refs
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Setup Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: ${{ inputs.python-version || '3.11' }}
          cache: 'pip'

      - name: üîç Validate Inputs
        shell: bash
        run: |
          set -euo pipefail  # Fail on error, undefined vars, pipe failures
          
          # Validate Python version (security: prevent invalid versions)
          PYTHON_VERSION="${{ inputs.python-version || '3.11' }}"
          case "$PYTHON_VERSION" in
            "3.9"|"3.10"|"3.11"|"3.12")
              echo "‚úÖ Valid Python version: $PYTHON_VERSION"
              ;;
            *)
              echo "‚ùå Invalid Python version: $PYTHON_VERSION"
              echo "‚úÖ Valid versions: 3.9, 3.10, 3.11, 3.12"
              exit 1
              ;;
          esac

          # Validate paths (security: prevent command injection and directory traversal)
          PATHS="${{ inputs.paths || 'src tests' }}"
          
          # Check for directory traversal
          if [[ "$PATHS" =~ \.\./ ]] || [[ "$PATHS" =~ \.\.\\ ]]; then
            echo "‚ùå Invalid paths: $PATHS"
            echo "‚úÖ Directory traversal (../) not allowed for security"
            exit 1
          fi
          
          # Check for shell injection attempts (semicolons, pipes, redirects, etc.)
          if [[ "$PATHS" =~ [;&|`$<>] ]]; then
            echo "‚ùå Invalid paths: $PATHS"
            echo "‚úÖ Shell metacharacters not allowed for security"
            exit 1
          fi
          
          # Only allow alphanumeric, spaces, slashes, dots, hyphens, underscores
          if [[ ! "$PATHS" =~ ^[a-zA-Z0-9 /._-]+$ ]]; then
            echo "‚ùå Invalid paths: $PATHS"
            echo "‚úÖ Only alphanumeric characters, spaces, slashes, dots, hyphens, and underscores allowed"
            exit 1
          fi

          echo "‚úÖ Input validation passed"
          echo "   Python version: $PYTHON_VERSION"
          echo "   Paths: $PATHS"

      - name: üì¶ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-formatters-${{ hashFiles('.github/workflows/auto-format-and-commit.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-formatters-

      - name: üì¶ Install formatters
        run: |
          # Security: isort >=5.13.2 fixes CVE-2023-38995 (command injection)
          pip install black==24.3.0 isort==5.13.2

      - name: üé® Run Black
        shell: bash
        run: |
          set -e
          TARGETS="${{ inputs.paths || 'src tests' }}"
          echo "Formatting: $TARGETS"
          if [ -f pyproject.toml ]; then
            black $TARGETS || exit 1
          else
            black $TARGETS --line-length 88 || exit 1
          fi

      - name: üîÄ Run isort
        shell: bash
        run: |
          set -e
          TARGETS="${{ inputs.paths || 'src tests' }}"
          echo "Sorting imports: $TARGETS"
          if [ -f pyproject.toml ]; then
            isort $TARGETS || exit 1
          else
            isort $TARGETS --profile black || exit 1
          fi

      - name: ‚öôÔ∏è Configure Git
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ensure remote URL is set for pushing
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Determine branch name (for PRs use head_ref, otherwise use ref name)
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          
          # If in detached HEAD, checkout the branch properly
          if [ "$(git rev-parse --abbrev-ref HEAD)" = "HEAD" ]; then
            git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          fi
          
          # Fetch the branch from remote to ensure it exists locally
          git fetch origin "$BRANCH_NAME:$BRANCH_NAME" || true

      - name: üìù Check for changes
        id: check-changes
        run: |
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected"
          fi

      - name: üßæ Commit formatting changes
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5.0.0
        with:
          commit_message: "chore: auto-format code with Black and isort"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          file_pattern: |
            **/*.py
            pyproject.toml
            setup.cfg

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `${{ steps.check-changes.outputs.has_changes == 'true' 
              ? '‚úÖ **Auto-format complete!**\n\nCode has been formatted with Black and isort and committed to this PR.\n\nCI checks should run automatically on the new commit.'
              : '‚ÑπÔ∏è  **No formatting changes needed.**\n\nCode is already properly formatted.' }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: ‚úÖ Summary
        if: always()
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Code formatted and committed successfully!"
            echo "üîÑ CI checks should now run automatically on this commit."
          else
            echo "‚ÑπÔ∏è  No formatting changes were needed. Code is already formatted."
          fi
