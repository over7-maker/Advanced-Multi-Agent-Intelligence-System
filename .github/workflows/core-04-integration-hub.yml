name: "Core-4: Integration Hub"

# Consolidated Integration Hub Workflow
# Combines: Comment Listener, Autonomy Orchestrator, Multi-Agent Orchestrator,
#           Master Orchestrators (3), Adaptive Prompt Improvement, AI Orchestrator
# Part of Workflow Consolidation: 46 workflows â†’ 8 cores

on:
  # Event triggers
  push:
    branches: [main, develop, feature/*, hotfix/*]
  pull_request:
    types: [opened, synchronize, reopened, closed, merged]
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created, edited]
  # Schedule triggers
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours for agent orchestration
  # Manual dispatch
  workflow_dispatch:
    inputs:
      integration_mode:
        description: 'Integration Mode'
        required: true
        default: 'intelligent'
        type: choice
        options:
          - intelligent
          - comment-listener
          - autonomy-orchestrator
          - multi-agent
          - master-orchestrator
          - adaptive-prompt
          - all
      agent:
        description: 'Specific agent to run (for autonomy orchestrator)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - workflow_orchestrator
          - data_validator
          - performance_optimizer
          - security_monitor
          - cost_optimizer
          - analytics_aggregator
          - rollback_guardian
      context:
        description: 'JSON context for agent execution'
        required: false
        type: string
        default: '{}'

env:
  PYTHON_VERSION: '3.11'
  INTEGRATION_MODE: ${{ github.event.inputs.integration_mode || 'intelligent' }}
  AGENT: ${{ github.event.inputs.agent || 'all' }}
  CONTEXT: ${{ github.event.inputs.context || '{}' }}

jobs:
  # Job 1: Comment Listener Integration
  comment_listener:
    name: ðŸ’¬ Comment Listener Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: env.INTEGRATION_MODE == 'intelligent' || env.INTEGRATION_MODE == 'comment-listener' || env.INTEGRATION_MODE == 'all' || github.event_name == 'issue_comment' || github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp requests openai anthropic google-generativeai groq cohere || true
        pip install PyGithub python-dotenv || true
    
    - name: ðŸ’¬ Process Comments
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
      run: |
        set -e
        set -o pipefail
        echo "ðŸ’¬ Processing comments and PR analysis..."
        
        if [ -f ".github/scripts/ai_agent_comment_listener.py" ]; then
          python .github/scripts/ai_agent_comment_listener.py || true
        else
          echo "â„¹ï¸ Comment listener script not found, skipping..."
        fi
    
    - name: ðŸ“¤ Upload Comment Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: comment-listener-results
        path: |
          comment_analysis_*.json
          pr_analysis_*.json
        if-no-files-found: ignore
        retention-days: 30

  # Job 2: Autonomy Orchestrator
  autonomy_orchestrator:
    name: ðŸ¤– Autonomy Orchestrator
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: env.INTEGRATION_MODE == 'intelligent' || env.INTEGRATION_MODE == 'autonomy-orchestrator' || env.INTEGRATION_MODE == 'all'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp requests PyYAML || true
    
    - name: ðŸ¤– Orchestrate Agents
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GPT4_API_KEY: ${{ secrets.GPT4_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        set -o pipefail
        echo "ðŸ¤– Orchestrating autonomous agents..."
        echo "Agent: $AGENT | Context: $CONTEXT"
        
        if [ -f ".github/scripts/agents/run_agents.py" ]; then
          python .github/scripts/agents/run_agents.py \
            --agent "$AGENT" \
            --context "$CONTEXT" \
            --output autonomy_orchestration_results.json || true
        else
          # Fallback: Basic orchestration
          python -c "
          import json
          
          result = {
              'timestamp': __import__('datetime').datetime.utcnow().isoformat(),
              'agent': '$AGENT',
              'context': '$CONTEXT',
              'status': 'success'
          }
          
          with open('autonomy_orchestration_results.json', 'w') as f:
              json.dump(result, f, indent=2)
          "
        fi
        
        echo "âœ… Autonomy orchestration completed"
    
    - name: ðŸ“¤ Upload Orchestration Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autonomy-orchestration-results
        path: autonomy_orchestration_results.json
        if-no-files-found: ignore
        retention-days: 30

  # Job 3: Multi-Agent Orchestrator
  multi_agent_orchestrator:
    name: ðŸ”— Multi-Agent Orchestrator
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: env.INTEGRATION_MODE == 'intelligent' || env.INTEGRATION_MODE == 'multi-agent' || env.INTEGRATION_MODE == 'all'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp requests PyYAML || true
    
    - name: ðŸ”— Run Multi-Agent Orchestration
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GPT4_API_KEY: ${{ secrets.GPT4_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        set -o pipefail
        echo "ðŸ”— Running multi-agent orchestration..."
        
        if [ -f ".github/scripts/ai_multi_agent_orchestrator.py" ]; then
          python .github/scripts/ai_multi_agent_orchestrator.py \
            --output multi_agent_results.json || true
        else
          echo "â„¹ï¸ Multi-agent orchestrator script not found, skipping..."
        fi
    
    - name: ðŸ“¤ Upload Multi-Agent Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: multi-agent-results
        path: multi_agent_results.json
        if-no-files-found: ignore
        retention-days: 30

  # Job 4: Master AI Orchestrators
  master_orchestrators:
    name: ðŸŽ¯ Master AI Orchestrators
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: env.INTEGRATION_MODE == 'intelligent' || env.INTEGRATION_MODE == 'master-orchestrator' || env.INTEGRATION_MODE == 'all'
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install anthropic==0.28.1 openai==1.35.0 google-generativeai==0.5.4 || true
        pip install replicate==0.28.0 mistralai==0.1.8 cohere==5.4.0 || true
        pip install together==1.0.1 groq==0.4.2 requests==2.32.3 || true
        pip install pydantic==2.6.3 loguru==0.7.2 tenacity==8.2.3 || true
        pip install aiohttp==3.9.3 pyyaml==6.0.1 jinja2==3.1.2 || true
        pip install gitpython==3.1.43 PyGithub==2.1.1 python-dotenv==1.0.0 || true
        pip install langchain==0.1.13 redis==5.0.1 chromadb==0.4.24 || true
        pip install numpy==1.26.4 pandas==2.2.0 scipy==1.12.0 || true
        pip install scikit-learn==1.4.2 black==24.1.1 ruff==0.3.5 || true
        pip install pylint==3.0.3 mypy==1.8.0 bandit==1.7.6 || true
    
    - name: ðŸŽ¯ Run Master Orchestration
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        UNSTRUCTURED_API_KEY: ${{ secrets.UNSTRUCTURED_API_KEY }}
        LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
        ELEVEN_LABS_API_KEY: ${{ secrets.ELEVEN_LABS_API_KEY }}
        QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LOG_LEVEL: 'INFO'
        AI_REASONING_DEPTH: 'advanced'
        AUTONOMY_LEVEL: 'maximum'
      run: |
        set -e
        set -o pipefail
        echo "ðŸŽ¯ Running Master AI Orchestration..."
        
        if [ -f ".github/scripts/ai_master_orchestrator.py" ]; then
          python .github/scripts/ai_master_orchestrator.py \
            --output master_orchestration_results.json || true
        else
          echo "â„¹ï¸ Master orchestrator script not found, skipping..."
        fi
    
    - name: ðŸ“¤ Upload Master Orchestration Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: master-orchestration-results
        path: master_orchestration_results.json
        if-no-files-found: ignore
        retention-days: 30

  # Job 5: Adaptive Prompt Improvement
  adaptive_prompt:
    name: ðŸ§  Adaptive Prompt Improvement
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: env.INTEGRATION_MODE == 'intelligent' || env.INTEGRATION_MODE == 'adaptive-prompt' || env.INTEGRATION_MODE == 'all'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp requests openai anthropic || true
    
    - name: ðŸ§  Run Adaptive Prompt Improvement
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GPT4_API_KEY: ${{ secrets.GPT4_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
      run: |
        set -e
        set -o pipefail
        echo "ðŸ§  Running adaptive prompt improvement..."
        
        if [ -f ".github/scripts/ai_adaptive_prompt_improvement.py" ]; then
          python .github/scripts/ai_adaptive_prompt_improvement.py \
            --output adaptive_prompt_results.json || true
        else
          echo "â„¹ï¸ Adaptive prompt improvement script not found, skipping..."
        fi
    
    - name: ðŸ“¤ Upload Adaptive Prompt Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: adaptive-prompt-results
        path: adaptive_prompt_results.json
        if-no-files-found: ignore
        retention-days: 30

  # Job 6: Integration Summary
  integration_summary:
    name: ðŸ“Š Integration Summary
    runs-on: ubuntu-latest
    needs: [comment_listener, autonomy_orchestrator, multi_agent_orchestrator, master_orchestrators, adaptive_prompt]
    if: always()
    
    steps:
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        pattern: '*'
        merge-multiple: true
    
    - name: ðŸ“Š Generate Summary
      run: |
        echo "ðŸ“Š Generating Integration Hub Summary"
        
        cat > integration_summary.md << EOF
        # ðŸ“Š Core-4: Integration Hub Summary
        
        ## ðŸ“ˆ **INTEGRATION OVERVIEW**
        - **Integration Mode**: ${{ env.INTEGRATION_MODE }}
        - **Timestamp**: $(date)
        - **Repository**: ${{ github.repository }}
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        
        ## âœ… **JOB STATUS**
        - **Comment Listener**: ${{ needs.comment_listener.result }}
        - **Autonomy Orchestrator**: ${{ needs.autonomy_orchestrator.result }}
        - **Multi-Agent Orchestrator**: ${{ needs.multi_agent_orchestrator.result }}
        - **Master Orchestrators**: ${{ needs.master_orchestrators.result }}
        - **Adaptive Prompt**: ${{ needs.adaptive_prompt.result }}
        
        ## ðŸ“¦ **INTEGRATION RESULTS**
        - Comment listener results
        - Autonomy orchestration results
        - Multi-agent coordination results
        - Master orchestration results
        - Adaptive prompt improvement results
        
        ## ðŸŽ¯ **NEXT STEPS**
        1. Review all integration results
        2. Monitor agent performance
        3. Optimize orchestration strategies
        4. Schedule next integration cycle
        
        ---
        *Generated by Core-4: Integration Hub - Consolidated from 8 workflows*
        EOF
        
        echo "âœ… Integration summary generated"
    
    - name: ðŸ“¤ Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: integration-summary
        path: integration_summary.md
        retention-days: 90
    
    - name: ðŸ“ Create Summary Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('integration_summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

