---
description: CI/CD Pipeline - GitHub Actions workflows, testing, building, and deployment automation
globs:
  - ".github/workflows/**/*.yml"
  - ".github/workflows/**/*.yaml"
  - "**/*ci*.yml"
alwaysApply: false
---

# CI/CD Pipeline Rules

When creating CI/CD pipelines:

## GitHub Actions Workflow Structure

1. **Complete CI/CD workflow**:
   ```yaml
   # ✅ CORRECT: Multi-job workflow
   name: Build, Test & Deploy
   
   on:
     push:
       branches: [main, develop]
     pull_request:
       branches: [main]
   
   env:
     REGISTRY: ghcr.io
     IMAGE_NAME: ${{ github.repository }}
   
   jobs:
     test:
       runs-on: ubuntu-latest
       services:
         postgres:
           image: postgres:15-alpine
           env:
             POSTGRES_DB: amas_test
             POSTGRES_USER: amas
             POSTGRES_PASSWORD: test_password
           ports:
             - 5432:5432
           options: >-
             --health-cmd pg_isready
             --health-interval 10s
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-python@v4
           with:
             python-version: '3.11'
         - run: pip install -r requirements.txt
         - run: pytest tests/ -v --cov=src
   ```

2. **Testing job**:
   ```yaml
   # ✅ CORRECT: Comprehensive testing
   test:
     name: Run Tests
     runs-on: ubuntu-latest
     services:
       postgres:
         image: postgres:15-alpine
         env:
           POSTGRES_DB: amas_test
           POSTGRES_PASSWORD: test_password
         ports:
           - 5432:5432
       redis:
         image: redis:7-alpine
         ports:
           - 6379:6379
     steps:
       - uses: actions/checkout@v4
       - uses: actions/setup-python@v4
         with:
           python-version: '3.11'
           cache: 'pip'
       - run: pip install -r requirements.txt pytest pytest-asyncio pytest-cov
       - run: alembic upgrade head
         env:
           DATABASE_URL: postgresql://amas:test_password@localhost:5432/amas_test
       - run: pytest tests/ -v --cov=src --cov-report=xml
       - uses: codecov/codecov-action@v3
         with:
           files: ./coverage.xml
   ```

3. **Frontend build**:
   ```yaml
   # ✅ CORRECT: Frontend build job
   build-frontend:
     name: Build Frontend
     runs-on: ubuntu-latest
     steps:
       - uses: actions/checkout@v4
       - uses: actions/setup-node@v4
         with:
           node-version: '18'
           cache: 'npm'
           cache-dependency-path: frontend/package-lock.json
       - run: npm ci
         working-directory: ./frontend
       - run: npm run build
         working-directory: ./frontend
       - uses: actions/upload-artifact@v3
         with:
           name: frontend-build
           path: frontend/build
   ```

4. **Docker build and push**:
   ```yaml
   # ✅ CORRECT: Docker build with caching
   build-docker:
     name: Build & Push Docker Image
     runs-on: ubuntu-latest
     needs: [test, build-frontend]
     if: github.ref == 'refs/heads/main'
     permissions:
       contents: read
       packages: write
     steps:
       - uses: actions/checkout@v4
       - uses: actions/download-artifact@v3
         with:
           name: frontend-build
           path: frontend/build
       - uses: docker/setup-buildx-action@v3
       - uses: docker/login-action@v3
         with:
           registry: ${{ env.REGISTRY }}
           username: ${{ github.actor }}
           password: ${{ secrets.GITHUB_TOKEN }}
       - uses: docker/metadata-action@v5
         id: meta
         with:
           images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
           tags: |
             type=ref,event=branch
             type=sha,prefix={{branch}}-
       - uses: docker/build-push-action@v5
         with:
           context: .
           push: true
           tags: ${{ steps.meta.outputs.tags }}
           cache-from: type=gha
           cache-to: type=gha,mode=max
           platforms: linux/amd64,linux/arm64
   ```

5. **Deployment job**:
   ```yaml
   # ✅ CORRECT: Kubernetes deployment
   deploy-production:
     name: Deploy to Production
     runs-on: ubuntu-latest
     needs: build-docker
     if: github.ref == 'refs/heads/main'
     environment:
       name: production
       url: https://amas.your-domain.com
     steps:
       - uses: actions/checkout@v4
       - uses: azure/setup-kubectl@v3
       - run: |
           echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
           export KUBECONFIG=kubeconfig.yaml
       - run: |
           kubectl apply -f k8s/
           kubectl rollout status deployment/amas-backend -n amas-production --timeout=5m
       - run: kubectl exec -n amas-production deployment/amas-backend -- alembic upgrade head
   ```

## Workflow Best Practices

1. **Always run tests before building** - Fail fast on errors
2. **Use service containers** - Test with real databases
3. **Cache dependencies** - Speed up builds (pip, npm)
4. **Upload artifacts** - Share build outputs between jobs
5. **Use matrix builds** - Test multiple Python/Node versions
6. **Conditional deployment** - Only deploy on main branch
7. **Use environments** - Protect production deployments
8. **Run migrations** - Apply database migrations after deployment
9. **Verify deployment** - Check pod status after rollout
10. **Send notifications** - Notify on success/failure (Slack, email)

## Security in CI/CD

1. **Never expose secrets** - Use GitHub Secrets
2. **Scan for vulnerabilities** - Run security scans in pipeline
3. **Use least privilege** - Minimal permissions for actions
4. **Sign artifacts** - Sign Docker images and releases
5. **Review dependencies** - Check for known vulnerabilities

## Best Practices

1. **Separate jobs** - Test, build, deploy in separate jobs
2. **Parallel execution** - Run independent jobs in parallel
3. **Fail fast** - Stop pipeline on first failure
4. **Use latest actions** - Keep actions up to date
5. **Document workflows** - Add comments explaining steps
6. **Version pinning** - Pin action versions for reproducibility
7. **Environment variables** - Use env context for shared values
8. **Artifact retention** - Set appropriate retention periods
9. **Branch protection** - Require CI to pass before merge
10. **Rollback plan** - Document rollback procedures
