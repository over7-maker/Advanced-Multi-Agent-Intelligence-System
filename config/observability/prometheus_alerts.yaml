# Prometheus Alert Rules for AMAS SLO Monitoring
# This file should be loaded by Prometheus Alertmanager

groups:
  - name: amas_slo_alerts
    interval: 30s
    rules:
      # Critical SLO Violations
      - alert: SLO_Critical_Violation
        expr: amas_slo_error_budget_remaining_percent < 5
        for: 2m
        labels:
          severity: critical
          component: slo
          runbook_url: "https://docs.amas.com/runbooks/slo-critical"
        annotations:
          summary: "Critical SLO violation - error budget nearly exhausted"
          description: "SLO {{ $labels.slo_name }} has only {{ $value }}% error budget remaining"
          action_required: "Immediate response required. Check runbook for remediation steps."
      
      - alert: Agent_Availability_Critical
        expr: |
          (
            rate(amas_agent_requests_total{status="success"}[5m]) /
            rate(amas_agent_requests_total[5m])
          ) * 100 < 95
        for: 5m
        labels:
          severity: critical
          component: agent
          runbook_url: "https://docs.amas.com/runbooks/agent-availability"
        annotations:
          summary: "Agent availability dropped below 95%"
          description: "Agent success rate is {{ $value }}%, below critical threshold of 95%"
      
      # High Priority Alerts
      - alert: SLO_High_Violation
        expr: amas_slo_error_budget_remaining_percent < 15
        for: 5m
        labels:
          severity: high
          component: slo
          runbook_url: "https://docs.amas.com/runbooks/slo-high"
        annotations:
          summary: "High priority SLO violation - error budget low"
          description: "SLO {{ $labels.slo_name }} has {{ $value }}% error budget remaining"
      
      - alert: Latency_Degradation
        expr: |
          histogram_quantile(0.95, 
            rate(amas_agent_duration_seconds_bucket[5m])
          ) > 2.0
        for: 10m
        labels:
          severity: high
          component: performance
          runbook_url: "https://docs.amas.com/runbooks/latency-degradation"
        annotations:
          summary: "Response latency significantly increased"
          description: "P95 latency is {{ $value }}s, above threshold of 2.0s"
      
      # Warning Alerts
      - alert: SLO_Warning_Violation
        expr: amas_slo_error_budget_remaining_percent < 25
        for: 10m
        labels:
          severity: warning
          component: slo
          runbook_url: "https://docs.amas.com/runbooks/slo-warning"
        annotations:
          summary: "Warning: SLO violation detected"
          description: "SLO {{ $labels.slo_name }} has {{ $value }}% error budget remaining"
      
      - alert: High_Error_Rate
        expr: rate(amas_agent_errors_total[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
          component: agent
          runbook_url: "https://docs.amas.com/runbooks/high-error-rate"
        annotations:
          summary: "Agent error rate higher than normal"
          description: "Error rate is {{ $value }} errors/sec"
      
      - alert: Resource_Usage_High
        expr: |
          (process_resident_memory_bytes / process_virtual_memory_max_bytes) > 0.75
        for: 15m
        labels:
          severity: warning
          component: system
          runbook_url: "https://docs.amas.com/runbooks/resource-usage"
        annotations:
          summary: "System resource usage approaching limits"
          description: "Memory usage is {{ $value | humanizePercentage }}"
      
      # Burn Rate Alerts
      - alert: ErrorBudget_FastBurn
        expr: amas_slo_error_budget_burn_rate > 14.4
        for: 5m
        labels:
          severity: critical
          component: slo
          runbook_url: "https://docs.amas.com/runbooks/burn-rate-fast"
        annotations:
          summary: "Error budget burning too fast"
          description: "SLO {{ $labels.slo_name }} is burning error budget at {{ $value }}x normal rate"
      
      - alert: ErrorBudget_SlowBurn
        expr: amas_slo_error_budget_burn_rate > 6.0
        for: 30m
        labels:
          severity: high
          component: slo
          runbook_url: "https://docs.amas.com/runbooks/burn-rate-slow"
        annotations:
          summary: "Sustained error budget consumption"
          description: "SLO {{ $labels.slo_name }} is consuming error budget at {{ $value }}x normal rate"

  - name: amas_performance_alerts
    interval: 30s
    rules:
      - alert: High_Queue_Depth
        expr: amas_queue_depth_current > 50
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Agent processing queue is backing up"
          description: "Queue depth is {{ $value }} pending requests"
      
      - alert: High_Token_Cost
        expr: |
          rate(amas_cost_usd_total[10m]) / 
          rate(amas_agent_requests_total{status="success"}[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
          component: cost
        annotations:
          summary: "Cost per request exceeds threshold"
          description: "Cost per request is ${{ $value }}, above threshold of $0.05"
      
      - alert: Low_Throughput
        expr: rate(amas_agent_requests_total[10m]) < 0.1
        for: 15m
        labels:
          severity: warning
          component: throughput
        annotations:
          summary: "Agent throughput is unusually low"
          description: "Request rate is {{ $value }} requests/sec"
